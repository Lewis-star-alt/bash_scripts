#!/bin/bash

echo "=== CMake Builder ==="

BUILD_DIR="build"
JOBS=4

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [clean]"
    echo "  clean - –æ—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
    echo "  –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –æ–±—ã—á–Ω–∞—è —Å–±–æ—Ä–∫–∞"
    exit 0
fi

if ! command -v cmake &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: cmake –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install cmake  # –¥–ª—è Ubuntu/Debian"
    exit 1
fi

if [! -f "CMakeLists.txt"]; then
    echo "‚ùå –û—à–∏–±–∫–∞: CMakeLists.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –ø–∞–ø–∫–∏ —Å CMake –ø—Ä–æ–µ–∫—Ç–æ–º"
    exit 1
fi

if ["$1" = "clean"]; then
    echo "üßπ –û—á–∏—â–∞—é –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É..."
    rm rf "$BUILD_DIR"
    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
fi

if [ ! -d "$BUILD_DIR"]; then
    echo "üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É —Å–±–æ—Ä–∫–∏..."
    mkdir "$BUILD_DIR"
fi

cd "$BUILD_DIR" || {
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É $BUILD_DIR"
    exit 1
}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º CMake
echo "‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é CMake..."
cmake .. || {
    echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CMake!"
    exit 1
}

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üèó –°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è $JOBS —è–¥–µ—Ä)..."
make -j "$JOBS" || {
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!"
    exit 1
}

echo ""
echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìÅ –§–∞–π–ª—ã –≤: $BUILD_DIR/"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–æ–±—Ä–∞–ª–æ—Å—å
echo ""
echo "üìã –°–æ–±—Ä–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
find . -maxdepth 1 -type f -executable ! -name ".*" 2>/dev/null | while read -r file; do
    echo "  ‚ñ∂Ô∏è $(basename "$file")"
done